<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<dom-module id="uva-accordion-item">
  <template>
    <style>
      :host {
        display: block;
      }
      [hidden] {
        display: none;
      }
      :host(:not([tree])) {
        border-top: 1px solid hsl(0, 0%, 82%);
      }
      .button[disabled] {
        cursor:default;
      }
      .button {
        display:inline-block;
        color:#444;
        background:#DDD;
        box-sizing: border-box;
        cursor:pointer;
        vertical-align:middle;
        padding: 5px;
        text-align: center;
      }
      :host(:not([tree])) .button {
        border:1px solid #CCC;
        box-shadow: var(--uvalib-box-shadow-custom, 0 0 5px -1px rgba(0,0,0,0.2));
      }
      .button:active {
        color:red;
        box-shadow: 0 0 5px -1px rgba(0,0,0,0.6);
      }
      .Accordion-trigger {
          background: none;
          border: 0;
          color: hsl(0, 0%, 13%);
          display: block;
          font-size: 1rem;
          font-weight: normal;
          margin: 0;
          padding: 1em 1.5em;
          position: relative;
          text-align: left;
          width: 100%;
          @apply --uva-accordion-item-trigger;
      }
      .Accordion-trigger:focus {
        background: hsl(0, 0%, 93%);
        @apply --uva-accordion-item-trigger-focus;
      }
      .Accordion-trigger:hover {
        background: hsl(0, 0%, 93%);
        @apply --uva-accordion-item-trigger-hover;
      }

      .Accordion-title {
        display: block;
/*        pointer-events: none; */
        @apply --uva-accordion-item-title;
      }
      :host([tree]) .Accordion-title {
        padding-left: 1.5em;
      }
      .Accordion-icon {
        border: solid hsl(0, 0%, 62%);
        border-width: 0 2px 2px 0;
        height: .5rem;
        pointer-events: none;
        position: absolute;
        right: 1.5em;
        top: 50%;
        transform: translateY(-60%) rotate(45deg);
        width: .5rem;
        @apply --uva-accordion-item-icon;
        transition: .5s ease-in-out;
      }
      :host([tree]) .Accordion-icon {
        left: 0.5em;
        transform: translateY(-60%) rotate(-45deg);
      }
      .Accordion-trigger:focus .Accordion-icon {
        border-color: hsl(0, 0%, 13%);
        @apply --uva-accordion-item-icon-focus;
      }
      .Accordion-trigger:hover .Accordion-icon {
        border-color: hsl(0, 0%, 13%);
        @apply --uva-accordion-item-icon-hover;
      }
      .Accordion-trigger[aria-expanded] .Accordion-icon {
        transform: translateY(-50%) rotate(-135deg);
        @apply --uva-accordion-item-icon-opened;
      }
      :host([tree]) .Accordion-trigger[aria-expanded] .Accordion-icon {
        transform: translateY(-50%) rotate(45deg);
        @apply --uva-accordion-item-icon-opened;
      }
      :host([tree]) .Accordion-trigger {
        padding: .5em;
      }
      .Accordion-panel {
        margin: 0;
        padding: var(--uva-accordion-item-panel-padding, 1em 1.5em);
        @apply --uva-accordion-item-panel;
      }
      :host([tree]) .Accordion-panel {
        margin-left: 0.5em;
      }
      :host([tree]) .body-item {
        display: grid;
        grid-template-rows: auto;

      }
      :host([tree]) ::slotted(div) {
        text-transform: capitalize;
      }
      :host([tree]) .body-item ::slotted(div) {
        padding: 5px;
      }
      .Accordion-panel[hidden] {
        display: none;
      }
      dt[role="heading"] {
        border-bottom: var(--uva-accordion-item-heading-border-bottom);
        @apply --uva-accordion-item-heading;
      }

    </style>
    <dt role="heading" aria-level$="[[headingLevel]]">
      <div role="button" disabled$="[[disabled]]" tabindex="0" id="accordionId" aria-expanded$="{{opened}}" class="button Accordion-trigger" aria-controls="bodysect" type="button">
        <span class="Accordion-title"><slot name="heading"></slot></span>
        <span class="Accordion-icon" hidden$="[[_or(noIcon,disabled)]]"></span>
      </div>
    </dt>
    <iron-collapse id="collapse" opened$="{{_isOpened(opened,disabled)}}" on-tap="_stopEvent">
      <dd id="bodysect" role="region" aria-labelledby="accordionId" class="Accordion-panel">
        <div class="body-item"><slot name="body"></slot></div>
      </dd>
    </iron-collapse>
  </template>

  <script>
    /**
     * `uva-accordion-item`
     *
     * ### Styling
     *
     * The following custom properties and mixins are available for styling:
     *
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--uva-accordion-item-trigger` | Mixin applied to the items button (header) | `{}`
     * `--uva-accordion-item-trigger-focus;` | Mixin applied to the items button (header) when focused | `{}`
     * `--uva-accordion-item-trigger-hover` | Mixin applied to the items button (header) when hovered | `{}`
     * `--uva-accordion-item-title` | Mixin applied to the items title span | `{}`
     * `--uva-accordion-item-icon` | Mixin applied to the items icon | `{}`
     * `--uva-accordion-item-icon-focus` | Mixin applied to the items icon when focused | `{}`
     * `--uva-accordion-item-icon-hover` | Mixin applied to the items icon when hovered | `{}`
     * `--uva-accordion-item-icon-opened` | Mixin applied to the items icon when opened | `{}`
     * `--uva-accordion-item-panel` | Mixin applied to the items panel  | `{}`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     * @demo demo/card.html Card Usage
     */
    class UvaAccordionItem extends Polymer.Element {
      static get is() { return 'uva-accordion-item'; }
      static get properties() {
        return {
          opened: {
            type: Boolean,
            notify: true,
            value: false
          },
          /** The heading level assigned to the items heading **/
          headingLevel: {
            type: Number,
            value: 3
          },
          tree: {
            type: Boolean,
            value: false
          },
          noIcon: {
            type: Boolean,
            value: false
          },
          disabled: {
            type: Boolean,
            value: false
          }
        };
      }
      _isOpened(opened){
        if (this.disabled) return true;
        else return opened;
      }
      _stopEvent(e) {
        e.stopPropagation();
      }
      _or(a,b) {
        return a || b;
      }
    }

    window.customElements.define(UvaAccordionItem.is, UvaAccordionItem);
  </script>
</dom-module>

<dom-module id="uva-accordion">
  <template>
    <style>
      :host {
        display: block;
      }
      :host(:not([tree])) .Accordion {
        border: 1px solid hsl(0, 0%, 82%);
        border-radius: .3em;
        box-shadow: 0 1px 2px hsl(0, 0%, 82%);
      }
      dl {
        @apply --uva-accordion-dl;
      }
    </style>
    <dl id="accordionGroup" role="presentation" class="Accordion">
      <iron-selector id="selector" multi="[[_or(multi,disabled)]]" selected="{{_selectedIndex}}" selected-attribute="opened" selected-item="{{_selectedItem}}" items="{{_items}}">
        <slot></slot>
      </iron-selector>
    </dl>
  </template>

  <script>
    /**
     * `uva-accordion`
     *
     * An accordion component taking direction from the WAI-Aria example.
     * https://www.w3.org/TR/wai-aria-practices-1.1/#accordion
     *
     ** ### Styling
     *
     * The following custom properties and mixins are available for styling:
     *
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--uva-accordion-dl` | Mixin applied to the dl wrapping the accordion | `{}`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     * @demo demo/card.html Card Usage
     */
    class UvaAccordion extends Polymer.mixinBehaviors([Polymer.IronA11yKeysBehavior], Polymer.Element) {
      static get is() { return 'uva-accordion'; }
      static get properties() {
        return {
          /** If true, multiple selections are allowed **/
          multi: {
            type: Boolean,
            value: false
          },
          /** the currently selected accordion node */
          _selectedItem: {
            type: Object,
            observer: '_selectedItemChanged'
          },
          _items: {
            type: Array,
            observer: '_activate',
          },
          disabled: {
            type: Boolean,
            value: false,
            observer: '_disabledChange'
          }
        };
      }
      get keyBindings() {
        return {
          'ctrl+pagedown': 'selectNext',
          'down': 'selectNext',
          'ctrl+pageup': 'selectPrevious',
          'up': 'selectPrevious',
          'end': 'selectLast',
          'home': 'selectFirst'
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this._checkDisabled();
        window.addEventListener('resize',function(e){ this._checkDisabled(); }.bind(this));
      }
      _checkDisabled(){
        const disabled = getComputedStyle(this).getPropertyValue('--uva-accordion-disabled');
        console.log("is disabled? "+disabled)
        if (this.disabled || (disabled && disabled.trim() != 'null' && disabled.trim() != 'false') ) this.disabled = true;
        else this.disabled = false;
      }
      _or(one,two) {
        return (one || two);
      }
      _disabledChange(before,after) {
        if (this.disabled) {
          this.selectAll();
          this._items.forEach(function(item,index){
            //item.noIcon=true;
            item.disabled=true;
          }.bind(this));
        }
        else if (before != null) {
          this._items.forEach(function(item,index){
            //item.noIcon=false;
            item.disabled=false;
          }.bind(this));
        }
      }
      _activate() {
        // Iron-selector doesn't init the selected state by attribute so we must do it :(
        this._items.forEach(function(item,index){
          if(item.hasAttribute('opened'))this.$.selector.selectIndex(index)
        }.bind(this));
        this._disabledChange();
      }

      selectAll() {
        this._items.forEach(function(item,index){
          item.setAttribute('opened',"");
        }.bind(this));
      }

      selectNext(e) {
        e.preventDefault();
        this.$.selector.selectNext();
        if (this._selectedItem) this._selectedItem.$.accordionId.focus();
      }
      selectPrevious(e) {
        e.preventDefault();
        this.$.selector.selectPrevious();
        if (this._selectedItem) this._selectedItem.$.accordionId.focus();
      }

      selectLast(e) {
        e.preventDefault();
        this.$.selector.selectIndex(this.$.selector.items.length-1);
        if (this._selectedItem) this._selectedItem.$.accordionId.focus();
      }
      /** Select and focus the first uva-accordion-item.  preventDefault method is run on an event passed as a parameter **/
      selectFirst(e) {
        e.preventDefault();
        this.$.selector.selectIndex(0);
        if (this._selectedItem) this._selectedItem.$.accordionId.focus();
      }
      /** Set disabled state, via aria-disabled, to an expanded / active accordion which is not allowed to be toggled close (when !multi ) */
      _selectedItemChanged(newNode, oldNode){
        if (!this.multi && newNode) {
          newNode.setAttribute('aria-disabled','');
        } else if (!this.multi && oldNode) {
          oldNode.removeAttribute('aria-disabled');
        }
      }
    }

    window.customElements.define(UvaAccordion.is, UvaAccordion);
  </script>
</dom-module>
